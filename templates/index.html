{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <form class="form-horizontal w-100 mt-3">
        <div class="row mb-3">
            <label for="administrativeDivision" class="col-sm-2 col-form-label">Административен район</label>
            <div class="col-sm-4">
                <select class="form-select" id="administrativeDivision">
                    <option selected disabled>Select Division</option>
                </select>
            </div>

            <label for="walkTime" class="col-sm-2 col-form-label">Време</label>
            <div class="col-sm-4">
                <input type="number" class="form-control" id="walkTime" value="5" min="1">
            </div>
        </div>

        <div class="row mb-3">
            <label for="amenityType" class="col-sm-2 col-form-label">Точки на интерес</label>
            <div class="col-sm-10">
                <select class="form-select" id="amenityType">
                    <option selected disabled>Изберете...</option>
                </select>
            </div>
        </div>
    </form>
</div>

<div id="map" class="flex-grow-1"></div>
{% endblock %}

{% block additionaljs %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const administrativeDivisionSelect = document.getElementById('administrativeDivision');
        const walkTimeInput = document.getElementById('walkTime');
        const amenityTypeSelect = document.getElementById('amenityType');

        // Function to fetch data and populate the administrative division dropdown
        async function populateAdministrativeDivisions() {
            const apiUrl = '/api/administrative-divisions';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const divisions = await response.json();

                // Clear existing options
                administrativeDivisionSelect.innerHTML = '<option selected disabled>Изберете...</option>';

                // Add new options from API data
                divisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division[0];
                    option.textContent = division[1];
                    administrativeDivisionSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error fetching administrative divisions:', error);
                const errorOption = document.createElement('option');
                errorOption.textContent = 'Error loading divisions';
                errorOption.disabled = true;
                administrativeDivisionSelect.appendChild(errorOption);
            }
        }

        function handleFormChange() {
            const settings = {
                administrativeDivision: administrativeDivisionSelect.value,
                walkTime: parseInt(walkTimeInput.value, 10),
                amenityType: amenityTypeSelect.value
            };
            console.log('Form settings changed:', settings);
        }

        // Call the function to populate the dropdown when the page loads
        populateAdministrativeDivisions();

        // Add event listeners for changes
        administrativeDivisionSelect.addEventListener('change', handleFormChange);
        walkTimeInput.addEventListener('change', handleFormChange);
        amenityTypeSelect.addEventListener('change', handleFormChange);

        // Initial log of settings when the page loads (after divisions are potentially loaded)
        handleFormChange();
    });
</script>


<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>

<script>
    // Initialize the map
    // Set view to a default location (e.g., Sofia) and zoom level
    const map = L.map('map').setView([42.6977, 23.3219], 15);

    // Add a Tile Layer (OpenStreetMap is a good default choice)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Layer group for isolines
    const isolays = L.layerGroup().addTo(map);

    // TODO: Just for debug purposes
    map.on('moveend', function (e) {
        var bounds = map.getBounds();
        if (bounds) {
            var northeast = bounds.getNorthEast();
            var southwest = bounds.getSouthWest();

            // alert("Northeast: " + northeast + "\n" +
            //     "Southwest: " + southwest);
        } else {
            alert("Bounds are not defined.");
        }
    })

    // ----------------------------------------------
    // Helpers
    // ----------------------------------------------
    /**
     * Fetches the value of a land property from the '/api/land-properties/get-value' endpoint.
     * This function expects latitude and longitude to be provided as query parameters to the API.
     *
     * @param {number} lat - The latitude of the clicked location.
     * @param {number} lng - The longitude of the clicked location.
     * @returns {Promise<any>} A promise that resolves with the JSON data from the API response,
     * or rejects if an error occurs during the fetch operation.
     */
    async function fetchLandPropertyValue(lat, lng) {
        try {
            const url = `/api/land-properties/get-value?lat=${lat}&lon=${lng}`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching land property value:', error);
            throw error;
        }
    }

    async function displayIsoline(latitude, longitude, color) {
        try {
            const propertyValueData = await fetchLandPropertyValue(latitude, longitude);
            isolays.clearLayers();
            L.geoJSON(propertyValueData, {
                style: {
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 0.5,
                    fillOpacity: 0.2
                }
            }).addTo(isolays);

        } catch (error) {
            console.error('Error fetching or displaying clicked property value:', error);
        }
    }

    function handleClickOnFeature(feature, layer) {
        // Create popup
        if (feature.properties) {
            let cadnum = feature.properties.cadnum;
            let ogc_fid = feature.properties.ogc_fid;
            let proptype = feature.properties.proptype;

            let jsString = `Cadastral Number: ${cadnum}<br/>
                        OGC FID: ${ogc_fid}<br/>
                        Property Type: ${proptype}`;

            layer.bindPopup(jsString);
        }
        // Display centroid
        layer.on('click', async function (e) {
            if (feature.properties && feature.properties.centroid) {
                const centroid = JSON.parse(feature.properties.centroid);

                const longitude = centroid.coordinates[0];
                const latitude = centroid.coordinates[1];
                const color = 'red'

                try {
                    displayIsoline(latitude, longitude, color)
                } catch (error) {
                    console.error('Error fetching or displaying clicked property value:', error);
                }
            }
        })
    }


    const fetchData = async () => {
        try {
            const response = await fetch('/api/land-properties');
            const geojsonData = await response.json();

            const geoJsonLayer = L.geoJSON(geojsonData, {
                onEachFeature: handleClickOnFeature
            }).addTo(map);

            map.on('click', async (e) => {
                const {lat, lng} = e.latlng; // Get latitude and longitude from the click event
                const color = 'green'

                try {
                    displayIsoline(lat, lng, color)
                } catch (error) {
                    console.error('Error fetching or displaying clicked property value:', error);
                }
            });

        } catch (error) {
            console.error('Error loading JSON data', error);
            alert('Error loading JSON data');
        }
    };

    fetchData();
</script>
{% endblock %}
