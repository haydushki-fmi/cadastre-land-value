{% extends 'base.html' %}

{% block content %}
<div id="map" class="flex-grow-1"></div>
{% endblock %}

{% block additionaljs %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>

<script>
    // Initialize the map
    // Set view to a default location (e.g., Sofia) and zoom level
    const map = L.map('map').setView([42.6977, 23.3219], 15);

    // Add a Tile Layer (OpenStreetMap is a good default choice)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Layer group for isolines
    const isolays = L.layerGroup().addTo(map);

    // TODO: Just for debug purposes
    map.on('moveend', function (e) {
        var bounds = map.getBounds();
        if (bounds) {
            var northeast = bounds.getNorthEast();
            var southwest = bounds.getSouthWest();

            // alert("Northeast: " + northeast + "\n" +
            //     "Southwest: " + southwest);
        } else {
            alert("Bounds are not defined.");
        }
    })


    function createPropertyPopup(feature, layer) {
        if (feature.properties) {
            let cadnum = feature.properties.cadnum;
            let ogc_fid = feature.properties.ogc_fid;
            let proptype = feature.properties.proptype;

            let jsString = `Cadastral Number: ${cadnum}<br/>
                        OGC FID: ${ogc_fid}<br/>
                        Property Type: ${proptype}`;

            layer.bindPopup(jsString);
        }
    }

    /**
     * Fetches the value of a land property from the '/api/land-properties/get-value' endpoint.
     * This function expects latitude and longitude to be provided as query parameters to the API.
     *
     * @param {number} lat - The latitude of the clicked location.
     * @param {number} lng - The longitude of the clicked location.
     * @returns {Promise<any>} A promise that resolves with the JSON data from the API response,
     * or rejects if an error occurs during the fetch operation.
     */
    async function fetchLandPropertyValue(lat, lng) {
        try {
            const url = `/api/land-properties/get-value?lat=${lat}&lon=${lng}`;

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching land property value:', error);
            throw error;
        }
    }


    const fetchData = async () => {
        try {
            const response = await fetch('/api/land-properties');
            const geojsonData = await response.json();

            const geoJsonLayer = L.geoJSON(geojsonData, {
                onEachFeature: createPropertyPopup
            }).addTo(map);

            // TODO: Just for now
            // map.fitBounds(geoJsonLayer.getBounds());

            // TODO: Replace with fetching on centroid?
            map.on('click', async (e) => {
                const {lat, lng} = e.latlng; // Get latitude and longitude from the click event
                const color = 'red'

                try {
                    const propertyValueData = await fetchLandPropertyValue(lat, lng);
                    isolays.clearLayers();
                    L.geoJSON(propertyValueData, {
                        style: {
                            fillColor: color,
                            color: color,
                            weight: 2,
                            opacity: 0.5,
                            fillOpacity: 0.2
                        }
                    }).addTo(isolays);

                } catch (error) {
                    console.error('Error fetching or displaying clicked property value:', error);
                }
            });

        } catch (error) {
            console.error('Error loading JSON data', error);
            alert('Error loading JSON data');
        }
    };

    fetchData();
</script>
{% endblock %}
